---
title: "Module 2F: Backwardation, Contango and the Roll Yield"
output:
  bookdown::html_document2:
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(here, dplyr, ggplot2, lubridate, kableExtra, readxl, janitor, tidyverse, purrr)
```

# Learning Outcomes

By working on this module you should be able to 

- 
- 


# Overview of this Module

Insert overview here

## Diversification Benefits of Commodities

:::: {.columns}

::: {.column width="50%"}
```{r correlation, echo=FALSE, fig.cap = "One year rolling return correlations", fig.align='center', out.width = "80%"}
knitr::include_graphics("Images/tangxiong2012.png")
```
:::

::: {.column width="50%"}
In Figure \@ref(fig:correlation), [Tang and Xiong (2012)](https://www.princeton.edu/~wxiong/papers/commodity.pdf) show the one-year rolling return correlations of oil with various commodities, together with the 95% confidence levels.

  - Assets which have a negative or low correlation with oil are desirable for diversification.
  - Notice the strong increase in the correlations in the run up to the commodity price boom of the mid 2000s. 
:::
::::

# Case Studies:  Two Commodity ETFs

  - Dow Jones-UBS Commodity Index (DJ-UBSCI) created in 2009 -- now called the Bloomberg Commodity Index. Read more from [Investing.com](https://www.investing.com/commodities/dow-jones-ubs-commodity) or [Wikipedia](https://en.wikipedia.org/wiki/Bloomberg_Commodity_Index)
  - [Powershares DB Agriculture Fund](https://etfdb.com/etf/DBA/#etf-ticker-profile) 
  - Benchmark with [Bank of Canada's commodity price index](https://www.bankofcanada.ca/rates/price-indexes/bcpi/)

The number of futures contracts held for each commodity are adjusted on a regular basis because price changes will affect the weight a commodity has within a portfolio. 

:::: {.columns}

::: {.column width="20%"}
```{r dbag, echo=FALSE, fig.cap = "DB Agriculture Index Commodities", fig.align='center', out.width = "100%"}
knitr::include_graphics("Images/db_ag.png")
```
:::

::: {.column width="80%"}
```{r bloombergindex, echo=FALSE, fig.cap = "Bloomberg Commodity Index Component Weights", fig.align='center', out.width = "80%"}
knitr::include_graphics("Images/bloombergindex.png")
```
:::

::::

In Figure \@ref(fig:bloombergindex-ts), the Bloomberg Commodity Index (black) performed poorly from 2017 to early 2020. Recent growth is well below the S&P 500 (orange).

```{r bloombergindex-ts, echo=FALSE, fig.cap = "Bloomberg Commodity Index and S&P500", fig.align='center', out.width = "50%"}
knitr::include_graphics("Images/bloombergindex_ts.png")
```

In this [article](https://www.etf.com/publications/journalofindexes/joi-articles/12274-better-beta-in-commodities-indexing.html), the author blames the poor performance of a crude oil ETF on frequent (once per month) contract rolling to avoid delivery. Rolling implies offseting a position in a futures contract set to expire, and taking a position in the next available contract. In Figure \@ref(fig:etf-rollyield) the author explains that rolling in a contango market results in a negative roll yield because for each roll, the investor is selling out of a lower-priced contract and buying into a higher priced contract. 

```{r etf-rollyield, echo=FALSE, fig.cap = "Bloomberg Commodity Index and S&P500", fig.align='center', out.width = "80%"}
knitr::include_graphics("Images/etf_rollyield.jpg")
```

In this lecture, we focus on roll yield for commodity futures. 

# Backwardation

In [Module 2D](https://vercammen.github.io/module2d.html) we used the eight quarter model to show that a USDA forecast for a sizeable weak Q8 carry out demand caused the forward curve to pivot down.

In Figure \@ref(fig:backwardation), we can see that the further out in time we go, the lower the expected spot price. As an example, let F1 = December contract, F2 = March contract, and F3 = May contract. Figure \@ref(fig:backwardation) shows that in time $t$, the expected spot price of the December contract is higher than the expected spot price of the March contract, and the expected spot price of the March contract is higher than the expected spot price of the May contract.

```{r backwardation, echo=FALSE, fig.cap = "Expected Spot Price Path and Forward Curve with Backwardation", fig.align='center'}
knitr::include_graphics("Images/backwardation.png")
```

# Contango 

Contango refers to an upward sloping forward curve. 

In [Module 2D](https://vercammen.github.io/module2d.html)  we used the eight quarter model to show that a USDA forecast for a sizeable strong Q8 cary out demand caused the forward curve to pivot up.

In Figure \@ref(fig:contango), we can see that the further out in time we go, the higher the expected spot price. As an example, let F1 = December contract, F2 = March contract, and F3 = May contract. Figure \@ref(fig:contango) shows that in time $t$, the expected spot price of the December contract is lower than the expected spot price of the March contract, and the expected spot price of the March contract is lower than the expected price of the May contract. 

```{r contango, echo=FALSE, fig.cap = "Expected Spot Price Path and Forward Curve with Contango", fig.align='center', out.width = "50%"}
knitr::include_graphics("Images/contango.png")
```

<!-- Only if you want to put these two images side by side!  -->
:::: {.columns}

<!-- I put 88% figure size for backwardation just to align the two pictures together!  -->
::: {.column width="50%"}
```{r backwardation2, echo=FALSE, fig.cap = "Expected Spot Price Path and Forward Curve with **Backwardation**", fig.align='center', out.width = "88%"}
knitr::include_graphics("Images/backwardation.png")
```
:::

::: {.column width="50%"}
```{r contango2, echo=FALSE, fig.cap = "Expected Spot Price Path and Forward Curve with **Contango**", fig.align='center', out.width = "100%"}
knitr::include_graphics("Images/contango.png")
```
:::

::::

# COVID Impacts on Corn Forward Curves

The blue bars in Figure \@ref(fig:corn) show the futures prices of different corn contracts on July 2, 2020 (right in the middle of the COVID-19 pandemic), and the orange bars show the futures prices of different corn contracts on June 2, 2021 (market was rebounding from COVID-19 pandemic). 

There was a strong contango market due to COVID-19 in July 2020. And as the markets rebound, we observe a backwardated market with current price higher than futures prices trading at a later date. 

```{r corn, echo=FALSE, fig.cap = "Contango (July 2020) and Backwardation (June 2021) in CME Corn Futures", fig.align='center', out.width = "60%"}
knitr::include_graphics("Images/corn_forward_curve.png")
```

:::: {.columns}

::: {.column width="50%"}
```{r corn-20, echo=FALSE, fig.cap = "Contango (July 2020) in CME Corn Futures", fig.align='center', out.width = "80%"}
knitr::include_graphics("Images/corn_forward_curve_20.png")
```
:::

::: {.column width="50%"}
```{r corn-21, echo=FALSE, fig.cap = "Backwardation (June 2021) in CME Corn Futures", fig.align='center', out.width = "80%"}
knitr::include_graphics("Images/corn_forward_curve_21.png")
```
:::

::::

# Roll Yield 

# Case Study: Crude Oil

Spot prices for oil come from the [U.S. E.I.A.](https://www.eia.gov/dnav/pet/hist/rwtcD.htm)

Figure \@ref(fig:wti-contango) shows the WTI Basis and March 2021 futures for a contango scenario. In this case, the basis is negative. This means that the cash price is lower than the first to expire futures price, which is then lower than the next following to expire futures price. The negative values of the basis suggest that we are in a contango market. 

```{r wti-contango, echo=FALSE, fig.cap = "WTI Crude Oil Futures and Basis **with Contango**", fig.align='center', out.width = "60%"}
knitr::include_graphics("Images/wti_contango.png")
```

:::: {.columns}

::: {.column width="50%"}
```{r wti-basis-contango, echo=FALSE, fig.cap = "WTI Crude Oil Basis **with Contango**", fig.align='center', out.width = "100%"}
knitr::include_graphics("Images/wti_basis_contango.png")
```
:::

:::{.column width="50%"}
```{r wti-futures-contango, echo=FALSE, fig.cap = "WTI Crude Oil Futures **with Contango**", fig.align='center', out.width = "100%"}
knitr::include_graphics("Images/wti_futures_contango.png")
```
:::

::::

In Figure \@ref(fig:forward-contango), we can see that the the forward curve is sloping upward. 

```{r forward-contango, echo=FALSE, fig.cap = "Forward Curve in a Contango Market", fig.align='center', out.width = "50%"}
knitr::include_graphics("Images/forward_contango.png")
```

```{r, eval = F}
```
Figure \@ref(fig:wti-backwardation) shows the WTI Basis and March 2021 futures for a contango scenario. In this case, the basis is falling but it is positive, which means that the cash price is higher than the next to expire futures contract, which has a price higher than the next following to expire futures contract.

```{r wti-backwardation, echo=FALSE, fig.cap = "WTI Crude Oil Futures and Basis **with Backwardation**", fig.align='center', out.width = "60%"}
knitr::include_graphics("Images/wti_backwardation.png")
```

:::: {.columns}

::: {.column width="50%"}
```{r wti-basis-back, echo=FALSE, fig.cap = "WTI Crude Oil Basis **with Backwardation**", fig.align='center', out.width = "100%"}
knitr::include_graphics("Images/wti_basis_back.png")
```
:::

:::{.column width="50%"}
```{r wti-futures-back, echo=FALSE, fig.cap = "WTI Crude Oil Futures **with Backwardation**", fig.align='center', out.width = "100%"}
knitr::include_graphics("Images/wti_futures_back.png")
```
:::

::::

## Backwardation scenario

In Figure\@ref(fig:forward-backwardation), we can see that the the forward curve is sloping downward. 

```{r forward-backwardation, echo=FALSE, fig.cap = "Forward Curve in a Contango Market", fig.align='center', out.width = "50%"}
knitr::include_graphics("Images/forward_backwardation.png")
```

# Constructing a Futures Joined Prices

## Roll Adjustment 

$Cumulative Roll Adjust_i = \sum_{j=1}^{i} RollAdjust_j$ 

We have 5 pricing periods:

  1. before first roll
  2. between first and second roll 
  3. between second and third roll
  4. between third and fourth roll
  5. after the fifth roll
  
## Joining the Futures Price

  1. Pricing Period 1 
    - Joined Price = Back Futures Price
  2. Pricing Period 2
    - Joined Price = Front Futures Price + Cumulative Roll $Adjustment_1$
  3. Pricing Period 3 
    - Joined Price = Front Futures Price + Cumulative Roll $Adjustment_2$
  4. Pricing Period 4 
    - Joined Price = Front Futures Price + Cumulative Roll $Adjustment_3$
  5. Pricing Period 5 
    - Joined Price = Front Futures Price + Cumulative Roll $Adjustment_4$

```{r joinedprices, echo=FALSE, fig.cap = "Forward Curve in a Contango Market", fig.align='center', out.width = "50%"}
combined_21 <- readRDS(here("Data", "combined_21.RDS"))
knitr::include_graphics("Images/joined_futures.png")
```

<!-- This is just clearer than the saved image  -->
```{r, echo = F}
combined_21 <- readRDS(here("Data", "combined_21.RDS"))

options(knitr.kable.NA ='')
combined_21 %>% select(time, spot, aug_21:dec_21, cum_roll, joined) %>%
  filter((time >= "2021-07-15" & time <= "2021-07-21") | 
           (time >= "2021-08-19" & time <= "2021-08-23") | 
           (time >= "2021-09-20" & time <= "2021-09-22") | 
           (time >= "2021-10-19" & time <= "2021-10-21") | 
           time == "2021-11-19") %>% 
  mutate(cum_roll = cell_spec(round(cum_roll, 2), align = "center", 
                              color = ifelse(time == "2021-07-20" |
                                               time == "2021-08-20"|
                                               time == "2021-09-21" |
                                               time == "2021-10-20", "red", "black"))) %>%
  # escape = F will need to work for the conditional color formatting
  kbl(escape = F, 
      col.names = c("Time", "Spot", "Aug 21", "Sep 21", "Oct 21", "Nov 21", "Dec 21", "Cum Roll", "Joined")) %>% 
  kable_styling(full_width = F)
```

In pricing period 1 (July 15, 2021), the joined price is the back futures price of `r combined_21$aug_21[combined_21$time == "2021-07-15"]`.

On July 20, 2021, the August contract expires and the index rolls over to the September contract. To calculate the joined price, we take the back price (about to expire contract) minus the front price (upcoming contract). For example, to get the cumulative roll of `r combined_21$cum_roll[combined_21$time == "2021-07-20"]` on July 20, 2021, we take the August contract price minus the September contract price, or `r combined_21$aug_21[combined_21$time == "2021-07-20"]` - `r combined_21$sep_21[combined_21$time == "2021-07-20"]`. To get the joined price, we add the cumulative roll to the front price, e.g. `r combined_21$cum_roll[combined_21$time == "2021-07-20"]` + `r combined_21$sep_21[combined_21$time == "2021-07-20"]` = `r combined_21$joined[combined_21$time == "2021-07-20"]`.

On August 20, 2021, the September contract expires and the index rolls over to the October contract. To calculate the cumulative roll of `r combined_21$cum_roll[combined_21$time == "2021-08-20"]`, we take the September contract price minus the October contract price and the previous roll, or (`r combined_21$sep_21[combined_21$time == "2021-08-20"]` - `r combined_21$oct_21[combined_21$time == "2021-08-20"]`) + `r combined_21$cum_roll[combined_21$time == "2021-07-20"]`. To get the joined price, we add the cumulative roll to the front price, e.g. `r combined_21$cum_roll[combined_21$time == "2021-08-20"]` + `r combined_21$oct_21[combined_21$time == "2021-08-20"]` = `r combined_21$joined[combined_21$time == "2021-08-20"]`.

On September 21, 2021, the October contract expires and the index rolls over to the November contract. To calculate the cumulative roll of `r combined_21$cum_roll[combined_21$time == "2021-09-21"]` on September 21, 2021, we take the October contract price minus the November contract price and the previous roll, or (`r combined_21$oct_21[combined_21$time == "2021-09-21"]` - `r combined_21$nov_21[combined_21$time == "2021-09-21"]`) + `r combined_21$cum_roll[combined_21$time == "2021-08-20"]`. To get the joined price on the September roll, we add the cumulative roll to the front price, e.g. `r combined_21$cum_roll[combined_21$time == "2021-09-21"]` + `r combined_21$nov_21[combined_21$time == "2021-09-21"]` = `r combined_21$joined[combined_21$time == "2021-09-21"]`.

## Verification that joined futures prices correctly calculates cumulative profits

We can verify that the joined futures prices correctly calculates cumulative profits. 

Let's the the example of two investors. Investor A takes a long position in the joined futures at the beginning date of July 15, 2021 and offsets this position at the ending date of November 19, 2021. 

Investor B rolls a long futures position through the five futures contracts, replacing the long position in the back contract with a long position in the front contract when the back contract expires. 


:::: {.columns}

::: {.column width="50%"}
```{r, echo = F}
investor_a <- readRDS(here("Data", "investor_a.RDS"))

investor_a %>% kbl(caption = "Investor A") %>% kable_styling(full_width = F) %>% row_spec(3, bold = T)
```
:::

::: {.column width="50%"}
```{r, echo = F}
investor_b <- readRDS(here("Data", "investor_b.RDS"))

investor_b %>% kbl(caption = "Investor B") %>% kable_styling(full_width = F) %>% row_spec(6, bold = T)
```
:::
::::

From Table \@ref(tab:return-compare), we see that 

```{r return-compare, echo = F}
options(knitr.kable.NA ='') # this converts NA to empty string

combined_21 %>% select(time, spot, aug_21:dec_21, cum_roll, joined) %>%
  filter(time == "2021-07-15" | time == "2021-07-16" |
           time == "2021-11-18" | time == "2021-11-19") %>% 
  # conditional formatting 
  mutate(spot = cell_spec(round(spot, 2), align = "center", 
                          background = ifelse(time == "2021-07-15" | time == "2021-11-19",
                                              "green", "white"),
                          color = ifelse(time == "2021-07-15" | time == "2021-11-19", 
                                         "white", "black"))) %>%
  mutate(aug_21 = replace_na(aug_21, '')) %>% 
           mutate(aug_21 = cell_spec(aug_21, align = "center",
                            background = ifelse(time == "2021-07-15", "green", "white"),
                             color = ifelse(time == "2021-07-15", "white", "black"))) %>%
  mutate(dec_21 = cell_spec(round(dec_21, 2), align = "center",
                            background = ifelse(time == "2021-11-19", "green", "white"),
                            color = ifelse(time == "2021-11-19", "white", "black"))) %>%
  mutate(joined = cell_spec(round(joined, 2), align = "center",
                            background = ifelse(time == "2021-07-15" | time == "2021-11-19",
                                                "orange", "white"),
                            color = ifelse(time == "2021-07-15" | time == "2021-11-19", "white", "black"))) %>%
  # escape = F will need to work for the conditional color formatting
  kbl(escape = F, 
      col.names = c("Time", "Spot", "Aug 21", "Sep 21", "Oct 21", "Nov 21", "Dec 21", "Cum Roll", "Joined"), 
      caption = "Comparing Investor A's and B's return") %>% 
  kable_styling(full_width = F)
```

An investor who held spot crude oil would earn `r combined_21$spot[combined_21$time == "2021-11-19"]` - `r combined_21$spot[combined_21$time == "2021-07-15"]` =  `r combined_21$spot[combined_21$time == "2021-11-19"] - combined_21$spot[combined_21$time == "2021-07-15"]` 

An investor who held joined futures would earn `r combined_21$joined[combined_21$time == "2021-11-19"]` - `r combined_21$joined[combined_21$time == "2021-07-15"]` = `r combined_21$joined[combined_21$time == "2021-11-19"] - combined_21$joined[combined_21$time == "2021-07-15"]`

# Roll Yield Defined

From Table \@ref(tab:roll-yield-defined), we see that the profits from holding joined futures minus the profits from holding spot (e.g. 5.37-4.44 = 0.93) is approximately equal to the cumulative roll of `r combined_21$cum_roll[combined_21$time == "2021-10-20"]` (in bold). 

```{r roll-yield-defined, echo = F}
options(knitr.kable.NA ='') # this converts NA to empty string

combined_21 %>% select(time, spot, aug_21:dec_21, cum_roll, joined) %>%
  filter(time == "2021-07-15" | time == "2021-10-19" |
           time == "2021-10-20" | time == "2021-10-21") %>% 
  # conditional formatting 
  mutate(spot = cell_spec(round(spot, 2), align = "center", 
                          background = ifelse(time == "2021-07-15", "green", "white"),
                          color = ifelse(time == "2021-07-15", "white", "black"))) %>%
  mutate(aug_21 = replace_na(aug_21, '')) %>% 
  mutate(aug_21 = cell_spec(aug_21, align = "center",
                            background = ifelse(time == "2021-07-15", "green", "white"),
                            color = ifelse(time == "2021-07-15", "white", "black"))) %>%
  mutate(nov_21 = replace_na(nov_21, '')) %>%
  mutate(nov_21 = cell_spec(nov_21, align = "center", 
                            background = ifelse(time == "2021-10-20", "yellow", "white"))) %>% 
  mutate(dec_21 = cell_spec(round(dec_21, 2), align = "center",
                            background = ifelse(time == "2021-10-20", "yellow", "white"))) %>% 
  mutate(cum_roll = cell_spec(round(cum_roll, 2), align = "center",
                              background = ifelse(time == "2021-10-20", "yellow", "white"),
                              bold = ifelse(time == "2021-10-20", T, F))) %>%
  mutate(joined = cell_spec(round(joined, 2), align = "center",
                            background = ifelse(time == "2021-07-15", "orange", 
                                                ifelse(time == "2021-10-20", "yellow", "white")),
                            color = ifelse(time == "2021-07-15" | time == "2021-11-19", "white", "black"))) %>%
           # escape = F will need to work for the conditional color formatting
           kbl(escape = F, 
               col.names = c("Time", "Spot", "Aug 21", "Sep 21", "Oct 21", "Nov 21", "Dec 21", "Cum Roll", "Joined"),
               caption = "Roll Yield Calculation") %>% 
           kable_styling(full_width = F)
```


# Contango Market

Figure \@ref(fig:contango-left) shows

Figure \@ref(fig:contango-right) shows

:::: {.columns}

::: {.column width="50%"}
```{r contango-left, echo=FALSE, fig.cap = "Adjusted Spot and Joined Futures, Oct 18-Dec 18", fig.align='center', out.width = "80%"}
knitr::include_graphics("Images/contango_left.png")
```
:::

::: {.column width="50%"}
```{r contango-right, echo=FALSE, fig.cap = "Adjusted Spot and Joined Futures, Dec 18-Feb 19", fig.align='center', out.width = "80%"}
knitr::include_graphics("Images/contango_right.png")
```
:::
::::

